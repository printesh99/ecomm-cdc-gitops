apiVersion: v1
kind: ConfigMap
metadata:
  name: outbox-db-init-sql
  namespace: db
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
    argocd.argoproj.io/sync-wave: "-1"
data:
  init.sql: |
    -- Ensure UUID generator is available
    CREATE EXTENSION IF NOT EXISTS "pgcrypto";

    -- Grants for Debezium
    GRANT USAGE ON SCHEMA cart, catalog, orders, payment, shipping TO debezium;
    GRANT SELECT ON ALL TABLES IN SCHEMA cart, catalog, orders, payment, shipping TO debezium;
    ALTER DEFAULT PRIVILEGES IN SCHEMA cart, catalog, orders, payment, shipping
      GRANT SELECT ON TABLES TO debezium;

    -- Publication owned by postgres
    DROP PUBLICATION IF EXISTS dbz_outbox_pub;
    CREATE PUBLICATION dbz_outbox_pub FOR TABLE
      cart.outbox_event,
      catalog.outbox_event,
      orders.outbox_event,
      payment.outbox_event,
      shipping.outbox_event;
